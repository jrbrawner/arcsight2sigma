<Rule Name="Domain is related to APT Malware Activity" Type="Normal" ID="5GMSOk3gBABCVtW9Bn7t7YA==">
  <Description>This rule will trigger when the domain is in the (additional) suspicious domain active list with threat level medium (APT malware)</Description>
  <Query>
    <FromClause>
      <Table Name="Event" Alias="event1" AliasType="Positive" />
    </FromClause>
    <WhereClause TimeWindowSize="2" TimeUnit="Minute" Threshold="1">
      <Condition ConditionType="Positive" TableAlias="event1">
        <And Name="And882967074">
          <Or Name="Or205212079">
            <BasicCondition Operator="InZone" JoinCondition="No" Negated="No" TableAlias="event1" IgnoreCase="Yes">
              <Variable TableAlias="event1" />
              <Resource ID="2FeIYfXgBABDFLJ2bkM6YFQ==" URI="/All Filters/ArcSight Foundation/Threat Intelligence Platform/Filter By Threat Level/Suspicious Domain/Destination in Suspicious Domain List APT Malware Related" />
            </BasicCondition>
            <BasicCondition Operator="InZone" JoinCondition="No" Negated="No" TableAlias="event1" IgnoreCase="Yes">
              <Variable TableAlias="event1" />
              <Resource ID="2r2ogfXgBABDFisiPcv6Csg==" URI="/All Filters/ArcSight Foundation/Threat Intelligence Platform/Filter By Threat Level/Suspicious Domain/Source in Suspicious Domain List APT Malware Related" />
            </BasicCondition>
          </Or>
          <Not Name="Not1348896512">
            <BasicCondition Operator="InActiveList" JoinCondition="No" Negated="No" TableAlias="event1" IgnoreCase="Yes" ListCompare="ANY">
              <Variable TableAlias="event1" Column="atkAddressByDirection" />
              <Variable TableAlias="event1" Column="atkZoneByDirection" />
              <Variable TableAlias="event1" Column="tgtAddressByDirection" />
              <Variable TableAlias="event1" Column="tgtZoneByDirection" />
              <Variable TableAlias="event1" Column="rule_DomainMediumThreat" />
              <Variable TableAlias="event1" Column="customer" />
              <Resource ID="H7hmfJGsBABCb1Q8yV0WVaA==" URI="/All Active Lists/ArcSight Foundation/Common/Suppression List/Attacker and Target Based Suppression" />
            </BasicCondition>
          </Not>
          <BasicCondition Operator="In" JoinCondition="No" Negated="No" IgnoreCase="No" ListCompare="ANY">
            <Variable Column="type" TableAlias="event1" />
            <Value>Base</Value>
            <Value>Aggregated</Value>
          </BasicCondition>
        </And>
      </Condition>
    </WhereClause>
    <GroupByClause>
      <Variable TableAlias="event1" Column="atkZoneByDirection" />
      <Variable TableAlias="event1" Column="destinationAddress" />
      <Variable TableAlias="event1" Column="rule_DomainMediumThreat" />
      <Variable TableAlias="event1" Column="dc_dstHostName" />
      <Variable TableAlias="event1" Column="tgtAddressByDirection" />
      <Variable TableAlias="event1" Column="atkAddressByDirection" />
      <Variable TableAlias="event1" Column="destinationZoneResource" />
      <Variable TableAlias="event1" Column="sourceAddress" />
      <Variable TableAlias="event1" Column="getThreatLevelMediumPriority" />
      <Variable TableAlias="event1" Column="aptTrackingDomainType" />
      <Variable TableAlias="event1" Column="getDomainValue" />
      <Variable TableAlias="event1" Column="getThreatLevelMediumSeverity" />
      <Variable TableAlias="event1" Column="tgtZoneByDirection" />
      <Variable TableAlias="event1" Column="dstAddressThreatLevel" />
      <Variable TableAlias="event1" Column="dc_srcHostName" />
      <Variable TableAlias="event1" Column="customerResource" />
      <Variable TableAlias="event1" Column="getOrginator" />
      <Variable TableAlias="event1" Column="sourceZoneResource" />
    </GroupByClause>
  </Query>
  <Actions>
    <Action Event="OnFirstEvent" Enabled="true">
      <SendToConsole />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="message" EventFieldValue="$getDomainValue" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="name" EventFieldValue="CRITICAL! Domain is related to APT Malware Activity" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="originator" EventFieldValue="$getOrginator" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="agentSeverity" EventFieldValue="$getMediumSeverity" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="categoryCustomFormatField" EventFieldValue="/Attack Life Cycle/Exploit" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="categoryOutcome" EventFieldValue="/Attempt" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="categorySignificance" EventFieldValue="/Suspicious" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="destinationHostName" EventFieldValue="$dc_dstHostName" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="sourceHostName" EventFieldValue="$dc_srcHostName" />
    </Action>
    <Action Event="OnFirstEvent">
      <SetEventField EventFieldName="priority" EventFieldValue="$getMediumPriority" />
    </Action>
    <Action Event="OnFirstEvent">
      <AddToList>
        <ActionParameter Name="Field" Value="atkAddressByDirection" />
        <ActionParameter Name="Field" Value="atkZoneByDirection" />
        <ActionParameter Name="Field" Value="tgtAddressByDirection" />
        <ActionParameter Name="Field" Value="tgtZoneByDirection" />
        <ActionParameter Name="Field" Value="rule_DomainMediumThreat" />
        <ActionParameter Name="Field" Value="customer" />
        <Resource ID="H7hmfJGsBABCb1Q8yV0WVaA==" URI="/All Active Lists/ArcSight Foundation/Common/Suppression List/Attacker and Target Based Suppression" />
      </AddToList>
    </Action>
    <Action Event="OnFirstEvent">
      <AddToList>
        <ActionParameter Name="Field" Value="getDomainValue" />
        <ActionParameter Name="Field" Value="atkAddressByDirection" />
        <ActionParameter Name="Field" Value="tgtAddressByDirection" />
        <ActionParameter Name="Field" Value="customer" />
        <ActionParameter Name="Field" Value="aptTrackingDomainType" />
        <ActionParameter Name="Field" Value="tgtZoneByDirection" />
        <ActionParameter Name="Field" Value="atkZoneByDirection" />
        <Resource ID="HeoHePHkBABCk5D31fpKOrg==" URI="/All Active Lists/ArcSight Foundation/Threat Intelligence Platform/APT TMP Tracking" />
      </AddToList>
    </Action>
  </Actions>
  <DependentVariables OwnerResourceID="5GMSOk3gBABCVtW9Bn7t7YA==">
    <BaseIntrospector Name="com.arcsight.event.SecurityEvent" />
    <DependentVariable FunctionName="eval_global_var" FieldName="dstAddressThreatLevel" FieldDisplayName="dstAddressThreatLevel">
      <FunctionFieldResource ID="Tg2-cjXgBABDcLlltEZzEcw==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Suspicious Address/dstAddressThreatLevel" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="dc_dstHostName" FieldDisplayName="dc_dstHostName">
      <FunctionFieldResource ID="TqWNP99URTBCUw0agaqKo9A==" URI="/All Fields/ArcSight Foundation/Common/dc_dstHostName" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="dc_srcHostName" FieldDisplayName="dc_srcHostName">
      <FunctionFieldResource ID="TcMGP92UBDDCUt0agEtWo9A==" URI="/All Fields/ArcSight Foundation/Common/dc_srcHostName" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="getOrginator" FieldDisplayName="getOrginator">
      <FunctionFieldResource ID="TfHTHkngBABDbFjboQobpqg==" URI="/All Fields/ArcSight Foundation/Common/Orginator by Traffic Direction/dc_getOrginator" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="atkZoneByDirection" FieldDisplayName="atkZone">
      <FunctionFieldResource ID="TtDfukngBABDPjXxhL0ZX-Q==" URI="/All Fields/ArcSight Foundation/Common/Orginator by Traffic Direction/dc_atkAddressZone" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="tgtAddressByDirection" FieldDisplayName="tgtAddress">
      <FunctionFieldResource ID="TeerwkngBABDXoODNq3WS0w==" URI="/All Fields/ArcSight Foundation/Common/Orginator by Traffic Direction/dc_tgtAddress" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="tgtZoneByDirection" FieldDisplayName="tgtZone">
      <FunctionFieldResource ID="T61DykngBABDsU4Cyveu6nA==" URI="/All Fields/ArcSight Foundation/Common/Orginator by Traffic Direction/dc_tgtAddressZone" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="atkAddressByDirection" FieldDisplayName="atkAddress">
      <FunctionFieldResource ID="TjpzrkngBABCvwJFG0Kx4Lg==" URI="/All Fields/ArcSight Foundation/Common/Orginator by Traffic Direction/dc_atkAddress" />
    </DependentVariable>
    <DependentVariable FunctionName="concat" FieldName="rule_DomainMediumThreat" FieldDisplayName="rule_DomainMediumThreat">
      <FunctionFieldValue Type="String"><![CDATA[Domain is related to APT Malware Activity]]></FunctionFieldValue>
      <FunctionFieldValue Type="String" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="dstDomainValue" FieldDisplayName="dstDomainValue">
      <FunctionFieldResource ID="TdbpquWsBABCDtYgtz4cdzg==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Suspicious Domain/dstDomainValue" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="getThreatLevelMediumSeverity" FieldDisplayName="getMediumSeverity">
      <FunctionFieldResource ID="T+ZUtI3kBABC523DRx8xMHA==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Common/Threat Level/Medium/getMediumSeverity" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="getThreatLevelMediumPriority" FieldDisplayName="getMediumPriority">
      <FunctionFieldResource ID="T4B0sI3kBABD22gLcd31YYQ==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Common/Threat Level/Medium/getMediumPriority" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="aptTrackingDomainType" FieldDisplayName="DOMAIN TYPE">
      <FunctionFieldResource ID="TSR5TPHkBABCDIgGRK6ZbmQ==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Constants/APT Tracking/DOMAIN TYPE" />
    </DependentVariable>
    <DependentVariable FunctionName="eval_global_var" FieldName="srcDomainValue" FieldDisplayName="srcDomainValue">
      <FunctionFieldResource ID="TGVL4sXgBABCGZBVNx1wIsg==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Suspicious Domain/srcDomainValue" />
    </DependentVariable>
    <DependentVariable FunctionName="replace_null" FieldName="getDomainValue" FieldDisplayName="getDomainValue">
      <FunctionFieldVariableResource>
        <FunctionFieldResource ID="TdbpquWsBABCDtYgtz4cdzg==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Suspicious Domain/dstDomainValue" />
      </FunctionFieldVariableResource>
      <FunctionFieldVariableResource>
        <FunctionFieldResource ID="TGVL4sXgBABCGZBVNx1wIsg==" URI="/All Fields/ArcSight Foundation/Threat Intelligence Platform/Suspicious Domain/srcDomainValue" />
      </FunctionFieldVariableResource>
    </DependentVariable>
  </DependentVariables>
</Rule>